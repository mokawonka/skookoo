<% @affiliated_epub = Epub.find(@document.epubid) %>

<!-- Saving book.locations to DB for the first opening -->
<% if @document.opened == 0 %>
  

    <div id="firstloading" class=centered>
        <h5 class=text-center> Preparing document for first read. </h5><br>
        <h5 class=text-center> Please wait. </h5>
        <br>
    </div>

      <!-- we only update the locations for the document owner-->
      <%= form_with(model: @document, url: [@document, :update_locations], local: false,  class: "d-none") do |form| %>

          <div class="field">
              <%= form.text_area :locations, { :id => 'document-locations' } %>
          </div>
          <div class="actions">
              <%= form.submit "submit", id: 'submitlocations'%>
          </div>

      <% end %>


    <script>

      async function displaybook(){

          $('#firstloading').html('<div class=text-center><%= image_tag "ready.png" %></div>');
          await new Promise(r => setTimeout(r, 2000));
          $('#firstloading').hide();

          window.location.reload();
      }

      // display loading message
      $('#firstloading').append('<div class=text-center><span id="loadspinner" class="spinner-border text-dark"></span></div>');
      $('#firstloading').show();

      // loading document
      var book = ePub("<%=rails_blob_path(@affiliated_epub.epub_file)%>");
    
      this.book.ready.then((book) => {

          // generating locations
          return this.book.locations.generate(600);
      
      }).then(function(locations){

          // saving locations to DB
          $('#document-locations').text(locations);
          $('#submitlocations').click();

          // reloading page to display book
          displaybook();
      });

    </script>

<% else %>

      <!-- we only update the progress for the document owner-->
      <% if logged_in? && current_user.id == @document.userid %> 

        <%= form_with(model: @document, url: [@document, :update_progress], local: false,  class: "d-none") do |form| %>

            <div class="field">
                <%= form.text_field :progress, { :id => 'reading-progress' } %>
            </div>
            <div class="actions">
                <%= form.submit "submit", id: 'submitprogress'%>
            </div>

        <% end %>

        <script>
            function updateProgressinDB() {
                if (!rendition || !book || !book.locations) return; // extra safety

                try {
                    const location = rendition.currentLocation();
                    if (!location?.start?.cfi) return;

                    const cfi = location.start.cfi;
                    const p = book.locations.percentageFromCfi(cfi);

                    if (typeof p === 'number' && !isNaN(p)) {
                        $('#reading-progress').val(p);
                        $('#submitprogress').click();
                    }
                } catch (err) {
                    console.warn("Progress update failed (view may have changed):", err);
                } finally {
                    timeoutHandle = null; // clean up
                }
            }
        </script>

      <% end %>



      <div id=allcontent class="row">

          <div id=content class="p-0">
          
            <div id="viewer" class="scrolled"></div>

            <a id="prev" href="#prev" class="arrow">‹</a>
            <a id="next" href="#next" class="arrow">›</a>
          </div>
          <div id=read_progressbar class=row></div>


          <div class="modal fade" id="highlightmodal" tabindex="-1" role="dialog" aria-labelledby="highlightLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                  <div class="modal-body">

                    <%= render "shared/createhighlight" %>

                  </div>
                </div>
            </div>
          </div>

          <div class="modal fade" id="conversationmodal" tabindex="-1" role="dialog" aria-labelledby="conversationLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="conversationmodalcontent">

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="resultmodal" tabindex="-1" role="dialog" aria-labelledby="resultLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                  <div class="modal-body" id="resultmodalcontent">
              
                  </div>
                </div>
            </div>
          </div>

          <div id="toc-toolbar" class="toolbar">
            <button id="toc-button">Table</button>
            <button id="settings-button">Settings</button>
          </div>

          <div id="toc-sidebar" class="toc-sidebar">
            <div class="toc-header">
              <h2>Table of Contents</h2>
              <button id="close-toc">✕</button>
            </div>
            <div id="toc-list" class="toc-list"></div>
          </div>

          <div id="settings-panel" class="settings-panel">
            <div class="settings-header">
              <h2>Reader Settings</h2>
              <button id="close-settings">✕</button>
            </div>
            <div class="settings-content">

              <!-- Font Size -->
              <div class="setting">
                <label>Font Size</label>
                <div class="slider-container">
                  <input type="range" id="font-size-slider" min="12" max="36" value="18" step="1">
                  <span id="font-size-value">18px</span>
                </div>
              </div>

              <!-- Line Spacing -->
              <div class="setting">
                <label>Line Spacing</label>
                <div class="slider-container">
                  <input type="range" id="line-height-slider" min="1.0" max="3.0" value="1.6" step="0.1">
                  <span id="line-height-value">1.6</span>
                </div>
              </div>

              <!-- Palette -->
              <div class="setting">
                <label>Background Palette</label>
                <div class="palette">
                  <button class="color-btn active" data-bg="#ffffff" data-color="#111111" style="background:#ffffff;"></button>
                  <button class="color-btn" data-bg="#f4ecd8" data-color="#3c2f2f" style="background:#f4ecd8;"></button>
                  <button class="color-btn" 
                          data-bg="#f5e8c7" 
                          data-color="#3c2f2f" 
                          style="background: #f5e8c7 url('<%= asset_path('textures/parchment.jpg') %>') repeat center / auto;">
                  </button>

                </div>
              </div>

            </div>
          </div>

      </div>

      <script>

        var book = ePub("<%=rails_blob_path(@affiliated_epub.epub_file)%>");

        var rendition = book.renderTo("viewer", { method: "continuous", flow: "scrolled",  width: "100%" , iframe: true});

        /* ─────────────────────────────────────────────
          GLOBAL SETTINGS
        ───────────────────────────────────────────── */

        function loadSettings() {
          // DB is the source of truth
          window.ebookSettings = {
            fontSize: <%= @document.font_size || 18 %>,
            lineHeight: <%= @document.line_height || 1.6 %>,
            bgColor: "<%= @document.bg_color || '#ffffff' %>",
            textColor: "<%= @document.text_color || '#111111' %>"
          };

          // Now sync localStorage to DB values
          localStorage.setItem("ebookSettings", JSON.stringify(window.ebookSettings));
        }


        function saveSettings() {
          localStorage.setItem("ebookSettings", JSON.stringify(window.ebookSettings));
        }

        /* ─────────────────────────────────────────────
          STABLE THEME ENGINE
        ───────────────────────────────────────────── */

        function applyTheme() {
          if (!rendition) return;

          const { fontSize, lineHeight, bgColor, textColor } = window.ebookSettings;

          const themeStyles = {
            "html": {
              "min-height": "100% !important",
              "height": "100% !important"
            },
            "body": {
              "min-height": "100vh !important",
              "background-color": bgColor + " !important",
              "color": textColor + " !important",
              "font-size": fontSize + "px !important",
              "line-height": lineHeight + "em !important"
            }
          };

          // Add parchment texture if needed
            if (bgColor.toLowerCase() === "#f5e8c7") {
            Object.assign(themeStyles.body, {
              "background-image": `url("<%= asset_path('textures/parchment.jpg') %>") !important`,
              "background-repeat": "repeat !important",
              "background-size": "auto !important"
            });
          } else {
            themeStyles.body["background-image"] = "none !important";
          }

          rendition.themes.register("custom", themeStyles);
          rendition.themes.select("custom");
        }



        book.ready.then(() => {
          rendition.themes.register("custom", {});
          rendition.themes.select("custom");
          loadSettings();
          applyTheme();
        });

        /* Reapply after each re-render */
        rendition.on("rendered", function () {
          applyTheme();
        });



        /* ─────────────────────────────────────────────
          SETTINGS PANEL CONTROLS
        ───────────────────────────────────────────── */
        <% if logged_in? && current_user.id == @document.userid %>
          function saveSettingsToDB() {
            const docId = "<%= @document.id %>";
            const updateSettingsPath = `/documents/${docId}/update_settings`;

            fetch(updateSettingsPath, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content
              },
              body: JSON.stringify({
                font_size: window.ebookSettings.fontSize,
                line_height: window.ebookSettings.lineHeight,
                bg_color: window.ebookSettings.bgColor,
                text_color: window.ebookSettings.textColor
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === "ok") {}
              else console.warn("Failed to save settings:", data.errors);
            })
            .catch(err => console.error("Error saving settings:", err));
          }
        <% else %>
          function saveSettingsToDB() {}; // dummy for non-owners
        <% end %>

        function initSettingsUI() {
          const button   = document.getElementById("settings-button");
          const panel    = document.getElementById("settings-panel");
          const toolbar  = document.getElementById("toc-toolbar");
          const closeBtn = document.getElementById("close-settings");

          if (!button || !panel || !closeBtn) return;

          // Open panel
          button.onclick = () => {
            const isOpen = panel.classList.toggle("open");
            if (toolbar) toolbar.style.display = isOpen ? "none" : "flex";
          };

          // Close panel
          closeBtn.onclick = () => {
            panel.classList.remove("open");
            if (toolbar) toolbar.style.display = "flex";
            saveSettingsToDB();   
          };

          // Load settings
          loadSettings();
          applyTheme();

          document.querySelectorAll(".color-btn").forEach(btn => {
            btn.classList.remove("active");

            if (btn.dataset.bg.toLowerCase() === window.ebookSettings.bgColor.toLowerCase()) {
              btn.classList.add("active");
            }
          });

          /* ───── Font Size ───── */
          const fontSlider = document.getElementById("font-size-slider");
          const fontValue  = document.getElementById("font-size-value");

          if (fontSlider) {
            fontSlider.value = window.ebookSettings.fontSize;
            fontValue.textContent = window.ebookSettings.fontSize + "px";

            fontSlider.oninput = (e) => {
              const value = parseInt(e.target.value);
              window.ebookSettings.fontSize = value;
              saveSettings();
              fontValue.textContent = value + "px";
              applyTheme();
            };
          }

          /* ───── Line Height ───── */
          const lineSlider = document.getElementById("line-height-slider");
          const lineValue  = document.getElementById("line-height-value");

          if (lineSlider) {
            lineSlider.value = window.ebookSettings.lineHeight;
            lineValue.textContent = window.ebookSettings.lineHeight.toFixed(1);

            lineSlider.oninput = (e) => {
              const value = parseFloat(e.target.value);
              window.ebookSettings.lineHeight = value;
              saveSettings();
              lineValue.textContent = value.toFixed(1);
              applyTheme();
            };
          }

          /* ───── Background Palette ───── */
          document.querySelectorAll(".color-btn").forEach(btn => {
            btn.onclick = () => {
              document.querySelectorAll(".color-btn")
                .forEach(b => b.classList.remove("active"));
              btn.classList.add("active");

              window.ebookSettings.bgColor   = btn.dataset.bg;
              window.ebookSettings.textColor = btn.dataset.color;

              saveSettings();
              applyTheme();
            };
          });
        }

        /* ────── TOC (FULLY RESTORED) ────── */
        function initTOC() {
          const toolbar = document.getElementById('toc-toolbar');
          const sidebar = document.getElementById('toc-sidebar');
          const tocButton = document.getElementById('toc-button');
          const closeToc = document.getElementById('close-toc');
          const tocList = document.getElementById('toc-list');

          if (!tocButton || !sidebar) return;

          function toggleSidebar() {
            const isOpen = sidebar.classList.toggle('open');
            if (toolbar) toolbar.style.display = isOpen ? 'none' : 'flex';
          }

          function closeSidebar() {
            sidebar.classList.remove('open');
            if (toolbar) toolbar.style.display = 'flex';
          }

          tocButton.onclick = toggleSidebar;
          closeToc.onclick = closeSidebar;

          if (typeof book !== 'undefined') {
            book.ready.then(() => renderTOC());
          }
        }

        function renderTOC() {
          const tocList = document.getElementById('toc-list');
          if (!tocList) return;
          tocList.innerHTML = '';

          function buildList(items) {
            const ul = document.createElement('ul');
            items.forEach(item => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = '#';
              a.textContent = item.label;
              a.onclick = (e) => {
                e.preventDefault();
                if (typeof rendition !== 'undefined') {
                  rendition.display(item.href);
                }
              };
              li.appendChild(a);

              if (item.subitems && item.subitems.length) {
                li.appendChild(buildList(item.subitems));
              }
              ul.appendChild(li);
            });
            return ul;
          }

          if (book?.navigation?.toc) {
            tocList.appendChild(buildList(book.navigation.toc));
          }
        }

        /* Safe initialization */
        function initializeAll() {
          initTOC();
          initSettingsUI(); 

          const toolbar = document.getElementById("toc-toolbar");
          const sidebar = document.getElementById("toc-sidebar");
          if (toolbar) toolbar.style.display = "flex";
          if (sidebar) sidebar.classList.remove("open");
        }
          

        /* Run safely */
        document.addEventListener("turbo:load", initializeAll);

        book.ready.then(function() {

            var stored ='<%= @document.locations %>';
            var sstored = stored.split(',epubcfi');

            for(var i = 1; i < sstored.length; i++){
              sstored[i] = 'epubcfi' + sstored[i];
            }

            return book.locations.load(sstored);

        }).then(function(locations){

          var url = window.location.href;

          function getCfiFromUrl() {
            var idx = url.indexOf('cfi=');
            if (idx === -1) return null;
            var raw = url.substring(idx + 4).split('&')[0];
            try {
              var cfi = decodeURIComponent(raw.replace(/\+/g, ' '));
              if (cfi && cfi.indexOf('epubcfi(') !== 0) cfi = 'epubcfi(' + cfi + ')';
              return cfi;
            } catch (e) {
              return raw.indexOf('epubcfi(') === 0 ? raw : 'epubcfi(' + raw + ')';
            }
          }

          async function scrollToHighlight(highlightCfi) {
            if (!highlightCfi) {
              rendition.display();
              return;
            }

            try {
              // First, let EPUB.js do its native navigation
              await rendition.display(highlightCfi);

              // Wait for the content to actually render (critical for bfcache restores)
              await new Promise(resolve => {
                const onRendered = () => {
                  rendition.off("rendered", onRendered);
                  resolve();
                };
                rendition.on("rendered", onRendered);

                // Safety fallback
                setTimeout(resolve, 900);
              });

              // Small extra delay for layout to settle (especially on back navigation)
              await new Promise(r => setTimeout(r, 300));

              // Now do precise scroll + centering
              let range = null;
              for (let content of rendition.getContents()) {
                try {
                  range = content.range(highlightCfi);
                  if (range) break;
                } catch (e) {}
              }

              if (range && range.startContainer) {
                // Force reflow
                void range.startContainer.parentElement.offsetHeight;

                const rect = range.getBoundingClientRect();
                const targetTop = rect.top + window.scrollY 
                                  - (window.innerHeight * 0.38) 
                                  + (rect.height / 2) 
                                  - 120;   // your offset

                window.scrollTo({
                  top: Math.max(0, targetTop),
                  behavior: "smooth"
                });
              }

            } catch (err) {
              console.error("goToHighlight failed, falling back:", err);
              rendition.display(highlightCfi);   // safe fallback
            }
          }


          <% if logged_in? && current_user.id == @document.userid %>
            // === Owner: Restore reading progress (only when no highlight link) ===
            if (url.indexOf('cfi') == -1) {
              var saved_percentage = '<%= @document.progress %>';
              var cfi = book.locations.cfiFromPercentage(saved_percentage);
              rendition.display(cfi);

              var sp = '<%= (@document.progress * 100).ceil() %>%';
              $('#read_progressbar').css('width', sp);
            }
          <% else %>
            // === Non-owner: Default display when no highlight link ===
            if (url.indexOf('cfi') == -1) {
              rendition.display();
            }
          <% end %>

          // === Common logic for everyone: Handle highlight link (cfi in URL) ===
          if (url.indexOf('cfi') != -1) {
            var highlightCfi = getCfiFromUrl();

            if (highlightCfi) {
              scrollToHighlight(highlightCfi, 120);

              <% if @target_highlight %>
                rendition.annotations.add("highlight", highlightCfi, {}, 
                  (e) => {
                    var content = "<div>" +
                      "<%= escape_javascript render('shared/onehighlight', highlight: @target_highlight, document: @document, from: 'document') %> <br>" +
                      "<%= escape_javascript render('shared/createreply', reply: Reply.new, highlight_id: @target_highlight.id, recipient_id: '', formwhatfor: 'creation') %> <br>" +
                      "<div id=allreplies>" +
                      "<%= escape_javascript render('shared/highlightreplies', replies: Reply.where(highlightid: @target_highlight.id).where(deleted: false).where(recipientid: nil), highlight: @target_highlight, type: 'parent') %>" +
                      "</div></div>";

                    $('#conversationmodalcontent').html(content);
                    $('#conversationmodal').modal('show');
                  },
                  "hl", {
                    fill: "yellow",
                    "fill-opacity": "0.2",
                    "mix-blend-mode": "multiply",
                    "pointer-events": "all",
                    style: "fill-opacity: 0.2; transition: fill-opacity 0.35s ease;",
                    onmouseenter: "this.style.fillOpacity='0.4'",
                    onmouseleave: "this.style.fillOpacity='0.2'"
                  }
                );
              <% else %>
                rendition.annotations.add("highlight", highlightCfi, {}, null, "highlight", {
                  fill: "yellow",
                  "fill-opacity": "0.2"
                });
              <% end %>

            } else {
              rendition.display();
            }
          }

        });


        function updateProgressbar()
        {
          var location = rendition.currentLocation();
          var cfi  = location.start.cfi;
          var p = book.locations.percentageFromCfi(cfi);

          if(p != null)
          {
            var sp = Math.ceil(p * 100) + '%';
            $('#read_progressbar').css('width', sp);
          }
        }

        var next = document.getElementById("next");
        next.addEventListener("click", function(e){
          e.preventDefault();
          var n = rendition.next();
        }, false);

        var prev = document.getElementById("prev");
        prev.addEventListener("click", function(e){
          e.preventDefault();
          var pr = rendition.prev();
        }, false);

        var keyListener = function(e){
          // Left Key
          if ((e.keyCode || e.which) == 37) {
            var pr = rendition.prev();
          }

          // Right Key
          if ((e.keyCode || e.which) == 39) {
            var n = rendition.next();
            // n.then(function(){updateprogress();});
          }

        };
        rendition.on("keyup", keyListener);
        document.addEventListener("keyup", keyListener, false);

        var timeoutHandle;
            rendition.on('relocated', function(location){
          updateProgressbar();
          <% if logged_in? && current_user.id == @document.userid %>
            // wait 7 seconds before updating progress
            window.clearTimeout(timeoutHandle);
            timeoutHandle = window.setTimeout(function(){updateProgressinDB();}, 7000);
          <% end %>
                });


        // loading highlights (berries) / public
        <% @highlights.each do |berry| %>          
          rendition.annotations.add("highlight", "<%=berry.cfi%>", 
                                    {}, 
                                    (e) => {
                                        var content = "<div>" + 
                                                      "<%=escape_javascript render 'shared/onehighlight' , highlight: berry, document: @document, from: 'document' %> <br>" +
                                                      "<%=escape_javascript render 'shared/createreply', reply: Reply.new, highlight_id: berry.id, recipient_id:'', formwhatfor: 'creation' %> <br>" +
                                                      "<div id=allreplies>" + "<%=escape_javascript render 'shared/highlightreplies', replies: Reply.where(:highlightid => berry.id).where(:deleted => false).where(:recipientid => nil), highlight: berry, type: "parent" %>" + "</div></div>";

                                        $('#conversationmodalcontent').html(content);
                                        $('#conversationmodal').modal('show');
                                    }, 
                                    "hl", {"fill": "#0951a9", "fill-opacity": "0.2", "mix-blend-mode": "multiply", "pointer-events": "all",
                                           "style": "fill-opacity: 0.2; transition: fill-opacity 0.35s ease;", "onmouseenter": "this.style.fillOpacity='0.4'", "onmouseleave": "this.style.fillOpacity='0.2'"})
        <% end %>

        <% if logged_in? && current_user.id == @document.userid %> // if user is owner of the document


          // ability to add highlights

          rendition.on("rendered", (section, view) => {

            // Now attach the mouseup listener (only once per section if possible)
            const doc = view.document;
            const win = view.window;

            doc.addEventListener("contextmenu", function(e) {
              e.preventDefault();
            });

            // Optional: remove previous listener if you attached it before
            doc.removeEventListener("mouseup", handleSelection);
            doc.addEventListener("mouseup", handleSelection);


            function handleSelection() {
              const selection = win.getSelection();
              if (selection.rangeCount === 0 || selection.isCollapsed) return;

              const range = selection.getRangeAt(0);
              const text = selection.toString().trim();
              if (text.length === 0) return;

              selection.removeAllRanges();

              try {
                const fullRangeCfi = section.cfiFromRange(range);
                //console.log("Generated range CFI:", fullRangeCfi);

                // Your UI code
                  // clearing old results if any
                  $('#emojiresults').empty();
                  $('#emojiresults').hide();
                  $('#gifresults').empty();
                  $('#gifresults').hide();
                  $('#gifsearch').val('');

                  $('#cfi').text(fullRangeCfi);
                  $('#highlight').find('blockquote').text(text);
                  $('#authors').text('<%=@document.authors%>');
                  $('#title').text('<%=@document.title%>');

                  $('#highlight').append('<br>');
                  $('#gifform').hide();
                  $('#commentform').hide();
                  $('#highlightmodal').modal('show');

                  //copy/translate gui reset
                  $("#copytext").text("Copy");

                  view.window.getSelection().removeAllRanges();
              } catch (err) {
                console.error("CFI generation crashed:", err);
              }
            }
          });


          // loading vocabulary / private
          <% @vocabs.each do |vocab| %>

            rendition.annotations.add("highlight", "<%=vocab.cfi%>", 
                                      {}, 
                                      (e) => {
                                      
                                      } , 
                                      "hl", {"fill": "green", "fill-opacity": "0.3", "mix-blend-mode": "multiply"})

          <% end %>


        <% end %> // if user is owner


      </script>

<% end %>